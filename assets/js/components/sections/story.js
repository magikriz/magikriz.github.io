(function(App) {

    'use strict';

    App.sections.storyChakras = function() {

        const storyData = {
            intro: "About me - Unfolding my journey through ten elemental chakras — each one revealing a chapter.",
            chakras: [
                {
                    order: 1,
                    image: "story-1.webp",
                    title: "Life Encoded",
                    story: [
                        "Hi, I'm Krishnan – a creative innovator, sparked by curiosity, driven by intent and fueled by passion, committed to building captivating and impactful digital experiences that inspires and impacts real world entities for the better. I am a Creative Web Developer proficient in Front-End Development with hands-on experience working on multiple technologies and frameworks as an individual and as part of teams in multiple organizations, in creative, technical, management and administrative roles. I believe being a developer is not just a profession but a style of life that defines how we perceive, analyze, dissect, plan, solve and prevail the challenges and needs that present before us in our lives, and how we sometimes create new features or optimize parts of ourselves, our life and surroundings into better versions.",
                    ],
                    keywords: ["Krishnan", "impactful digital experiences", "Creative Web Developer", "creative, technical, management and administrative roles.", "style of life", "challenges", "features", "versions"],
                    icon: "fa-microchip"                    
                },
                {
                    order: 2,
                    image: "story-2.webp",
                    title: "Digital Roots",
                    story: [
                        "As a 90's kid, I grew up exploring and spending more time with books and screens and it evolved into my hobbies and interests. Learning about the advancements in technology, computers, the internet and more has always fascinated me, and that’s one of the main reasons for me choosing this career path because it fits right into my forte, interests and the vision and goals I have for my life and career.",
                    ],
                    keywords: ["90's kid", "evolved", "hobbies", "interests", "technology", "career path", "vision and goals"],
                    icon: "fa-child-reaching"                    
                },
                {
                    order: 3,
                    image: "story-3.webp",
                    title: "Academic Foundation",
                    story: [
                        "I did 10 years my schooling in a school near my town - Chinmaya Vidyalaya, Pallavur. It was a great institution and had some inspiring teachers and good standard of education. These were some of the best years of my life and gave me a solid foundation to my knowledge, learning and values and some long lasting friendships that has stood the test of time and distance. I chose my direction to be Computer Science right from my higher secondary education. And i had a successful academic beginning walking out of this school in 2010. I did my Bachelor's at Federal Institute of Science and Technology (FISAT) - Angamaly, from 2010-2014 on Computer Science and Engineering. These 4 years gave me some invaluable life knowledge and information that's not just from the books, but from everything I experienced during this time and has helped and inspired me all along my journey since.",
                    ],
                    keywords: ["schooling", "standard of education", "solid foundation", "direction", "Computer Science", "Bachelor's", "Computer Science and Engineering", "life knowledge", "my journey"],
                    icon: "fa-book-open-reader"                    
                },
                {
                    order: 4,
                    image: "story-4.webp",
                    title: "Hello World",
                    story: [
                        "Currently, I focus on mastering Web App Development from end to end with various stacks and frameworks. I plan on broadening my spectrum to other technologies, platforms and domains eventually. I’m passionate about this and I have the experience of working in different web technologies and frameworks on a variety of projects - open source and client work, as part of teams in multiple organizations, and also independently as an individual or a freelance professonal. The advent of Generative AI LLMs and ts growing role in software industry is something that has piqued my interest in the last few years and I look forward to expand my horizons into that field as well on all the possibilities of how it can assist our purposes in this and make a difference in this ever advancing digital world.",
                    ],
                    keywords: ["Front End Development", "variety of projects", "multiple organizations", "freelance professonal", "Generative AI LLMs", "digital world"],
                    icon: "fa-laptop-code"                    
                },
                {
                    order: 5,
                    image: "story-5.webp",
                    title: "Creative Pulse",
                    story: [
                        "Branding along with Rich Writing has been my passion ever since I was a kid. I have always been involved in composing verses, essays, blogs, articles etc. and creating designs, chartworks, videos, social media posts and websites to hype up ideas, stories, events, businesses and people, with quality content in creative and authentic ways both individually and as part of teams. Being a kid, math, science and languages were my favorite subjects and strengths. And I've always enjoyed reading, watching and learning about technology, science, history, arts, crafts and more.",
                    ],
                    keywords: ["Branding", "passion", "quality content", "strengths"],
                    icon: "fa-feather"                    
                },
                {
                    order: 6,
                    image: "story-6.webp",
                    title: "Into the Spotlight",
                    story: [
                        "I hail from the central part of Kerala, one of the southern states of India, well known for its diverse artforms, medical heritage, delicious cuisine, cultural diversity and the plethora of festivals celebrated across the region throughout the calendar. I'm an ardent sports buff. I love to travel, photograph, connect with nature and also people. I enjoy music, movies, books, art, anime, gaming and deep conversations. I love exploring and experiencing places, cultures, languages, lifestyles, festivals and the marvels of nature and human excellence; or just simply hanging out in a room with friends. I'm a big fan of specific eras of few teams for how they played together, what they achieved and how they levelled up their sport and inspired millions. I admire many individuals in each sport I follow. But the 4 individuals that have always been an inspiration to me, not just with their game, but with who they are, and how they live life are Sachin, Federer, Messi and Rohit. Also, I'm a big fan of Live performances, Unplugged Covers, EDM, Rock Music and other music genres as well. Several fictional universes of books, comics, anime and movie/series like Pokémon, Harry Potter, Beyblade, Game of Thrones and many others have been a significant source of inspration for me in life.",
                    ],
                    keywords: ["sports", "travel", "conversations", "friends", "eras", "teams", "individuals", "inspiration", "music genres", "fictional universes"],
                    icon: "fa-futbol"                    
                },
                {
                    order: 7,
                    image: "story-7.webp",
                    title: "Together Everyone Achieves More",
                    story: [
                        "I have seen, learned and experienced how good chemistry is a significant part of successful teams. A group of individuals that interact, understand and collaborate with each other totally committed towards common goals, forming a rapport, having fun, bantering and bettering themselves and each other in the process of achieving big things together is as good as the story gets. We see, hear and read about many such teams in various domains and disciplines that make transformational advancements and enjoy collective success in their respective fields, inspiring generations around the world. As an individual and a professional, it is my biggest aspiration to be part of such teams, making significant contributions and performing to the best of my abilities towards achieving the team goals and working towards greater ones.",
                    ],
                    keywords: ["chemistry", "successful teams", "committed", "rapport", "transformational", "collective", "generations", "aspiration", "goals"],
                    icon: "fa-atom"                    
                },
                {
                    order: 8,
                    image: "story-8.webp",
                    title: "Levels",
                    story: [
                        "Be it in art, sport, technology, business, gaming or in life itself, there are always phases, halves and levels. You may do well in some of them, great in some, and bad in some as well. There might be milestones and mistakes along the way no matter what you choose to pursue. There might be breaks, pauses, detours and unforeseen scenarios in your journey that may affect your flow, focus and confidence, and it may not be in your control.  But it always rests upon you as to when and how you get back on your pursuit and better your focus, mentality, strategy, skills, game and level - and with time and effort, build your confidence back and find a way to achieve your goals and ambitions.",
                    ],
                    keywords: ["phases", "halves", "levels", "flow", "focus", "confidence", "get back", "goals", "ambitions"],
                    icon: "fa-chart-line"                    
                },
                {
                    order: 9,
                    image: "story-9.webp",
                    title: "Cosmic Collective",
                    story: [
                        "I believe in the unknowns of a higher conciousness and how events come in ripples and how small random shifts can have a butterfly effect in the world and our lives. I value honesty, intent, depth, respect, curiosity and kindness in anyone I connect with; and strive for excellence in anything I engage in. Setting goals, analyzing the possibilities and challenges, visualizing the path, planning actions and executing them to attain them is how I process to take each step in my life. I have made my passion, ambition and pursuit align in the same direction and its my nature to go all in on anything I commit to - in life, career or anything else and always try bring my best focus and intensity to it. I never give up on what I believe in, no matter what comes along the way. I have seen how momentum shifts energy, belief and mentality in any team or individual, how it fuels performance and shape results; and that is exactly what I aim to build as I step into a new beginning.",
                    ],
                    keywords: ["conciousness", "ripples", "butterfly effect", "excellence", "process", "commit", "align", "all in", "momentum", "new beginning"],
                    icon: "fa-code-commit"                    
                },
                {
                    order: 10,
                    image: "story-10.webp",
                    title: "The Twist in the Tale",
                    story: [
                        "I have experience handling / being part of every phase of a project - right from brainstorming ideas to deployment and maintenance, in professional structured work environments with teams for large projects and independently for freelance client works - on live projects or from the ground up, utilizing a variety of modern technologies and methods. The evolution of AI LLMs has significantly transformed the associated skillsets and updated the processing workflows within IT Projects in the Corporate Tech Industry. Even though I have a gap of more than 2 years on my corporate career, I have actively kept myself informed and in practice of these changes to ensure that I remain relevant to the New Standards of Web Development and its associated tasks, as I prepare to make a comeback on my career and re-enter the workforce. I believe that in every adversity, lies an opportunity for an epic comeback story, and I'm working towards mine - gathering information, refining skillset, levelling up, Training, cultivating confidence and hunting opportunities to make it a reality in career and life. With my best efforts, and destiny on my side, I shall accomplish it in the best way possible.",
                    ],
                    keywords: ["every phase of a project", "evolution of AI LLMs", "New Standards of Web Development", "adversity", "opportunity", "epic comeback", "reality", "best efforts"],
                    icon: "fa-arrows-spin"                    
                },
            ]
        }

        function generateStoryContent(storyData) {

            // Utility: escape regex special characters in keyword
            function escapeRegex(str) {
                return str.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            }

            // Highlight the first occurrence of each keyword in text, including trailing punctuation
            function highlightKeywords(text, keywords) {
                keywords.forEach((kw) => {
                    const escaped = escapeRegex(kw);
                    const regex = new RegExp(`\\b(${escaped})([.,;:!?:])?`, 'i');
                    text = text.replace(regex, (match, p1, p2) => {
                        if (p2) return `<strong>${p1}${p2}</strong>`;
                        return `<strong>${p1}</strong>`;
                    });
                });
                return text;
            }

            // Create root container
            const storyRoot = document.querySelector('.kd-story');
            const root = document.querySelector('.story-content');
            
            // Create chakras container
            const storyCanvas = document.createElement('canvas');
            storyCanvas.className = 'story-canvas';
            storyCanvas.id = 'storyStormCanvas';
            storyRoot.appendChild(storyCanvas);
                        
            // Create intro
            const introDiv = document.createElement('div');
            introDiv.className = 'story-intro section-intro hoverable';
            const introP = document.createElement('p');
            introP.className = 'hoverable';
            introP.textContent = storyData.intro || '';
            introDiv.appendChild(introP);
            root.appendChild(introDiv);

            // Create chakras container
            const chakrasContainer = document.createElement('div');
            chakrasContainer.className = 'story-chakras';

            // List wrapper
            const listWrapper = document.createElement('div');
            listWrapper.className = 'chakras-list';

            // Single popup wrapper (hidden by default)
            const popupOverlay = document.createElement('div');
            popupOverlay.className = 'chakras-popup';

            // Popup controls: left arrow, right arrow, close
            const popupLeft = document.createElement('div');
            popupLeft.className = 'chakra-popup-left';
            popupLeft.textContent = '‹'; // use a left arrow glyph

            const popupRight = document.createElement('div');
            popupRight.className = 'chakra-popup-right';
            popupRight.textContent = '›'; // use a right arrow glyph

            const popupClose = document.createElement('div');
            popupClose.className = 'chakra-popup-close';
            popupClose.textContent = '⛌';

            // Content container inside popup
            const popupContent = document.createElement('div');
            popupContent.className = 'chakras-content';

            // Content container inside popup
            const popupImageContent = document.createElement('div');
            popupImageContent.className = 'chakras-image-content';

            // Content container inside popup
            const popupTextContent = document.createElement('div');
            popupTextContent.className = 'chakras-text-content';

            // Image element (lazy-loaded via data-src)
            const popupImage = document.createElement('img');
            popupImage.className = 'chakra-image';
            popupImage.alt = '';
            popupImage.loading = 'lazy';

            // Separator
            const popupHr = document.createElement('hr');
            popupHr.className = 'chakra-separator';

            // Title
            const popupTitle = document.createElement('h4');
            popupTitle.className = 'chakras-title';

            // Description paragraph
            const popupDesc = document.createElement('p');
            popupDesc.className = 'chakras-description';

            // Assemble popup content
            popupImageContent.appendChild(popupImage);
            popupImageContent.appendChild(popupHr);
            popupTextContent.appendChild(popupTitle);
            popupTextContent.appendChild(popupDesc);
            popupContent.appendChild(popupImageContent);
            popupContent.appendChild(popupTextContent);

            // Assemble popup overlay
            popupOverlay.appendChild(popupLeft);
            popupOverlay.appendChild(popupRight);
            popupOverlay.appendChild(popupClose);
            popupOverlay.appendChild(popupContent);

            // Append list and popup to container
            chakrasContainer.appendChild(listWrapper);
            chakrasContainer.appendChild(popupOverlay);
            root.appendChild(chakrasContainer);

            // Track current order displayed
            let currentOrder = null;
            const total = storyData.chakras.length;

            function animateEntranceStaggered(elements, delay = 100) {
                elements.forEach((el, index) => {
                    el.classList.remove('fade-rotate-in'); // reset
                    void el.offsetWidth; // force reflow
                    setTimeout(() => {
                        el.classList.add('fade-rotate-in');
                        el.addEventListener('animationend', function handler() {
                            el.classList.remove('fade-rotate-in');
                            el.removeEventListener('animationend', handler);
                        });
                    }, index * delay);
                });
            }

            function animateExit(elements, callback) {
                let completed = 0;
                elements.forEach(el => {
                    el.classList.remove('fade-rotate-in'); // reset entrance
                    el.classList.add('fade-rotate-out');

                    // Wait for animation to finish
                    el.addEventListener('animationend', function handle() {
                    el.classList.remove('fade-rotate-out');
                    el.removeEventListener('animationend', handle);

                    completed++;
                    if (completed === elements.length) {
                        callback?.(); // When all finished, run callback
                    }
                    });
                });
            }

            // Update popup content based on order
            function updatePopupContent(order) {
                const chakra = storyData.chakras.find((c) => c.order === order);
                if (!chakra) return;

                const elements = [popupImage, popupHr, popupTitle, popupDesc];

                // Apply exit animation to all
                animateExit(elements, () => {
                    // Update image
                    popupImage.setAttribute('data-src', `assets/images/story/chakras/${chakra.image}`);
                    popupImage.alt = chakra.title || '';
                    // Load image if not loaded
                    if (popupImage.dataset.src) {
                        popupImage.src = popupImage.dataset.src;
                        delete popupImage.dataset.src;
                    }

                    // Update title
                    popupTitle.textContent = chakra.title;

                    // Update description with highlighted keywords
                    const rawText = Array.isArray(chakra.story) ? chakra.story.join(' ') : chakra.story;
                    popupDesc.innerHTML = highlightKeywords(rawText, chakra.keywords || []);

                    // Entrance animation (staggered)
                    animateEntranceStaggered(elements, 0); // 100ms delay between each
                });
            }
            
            // Navigate to next or previous
            function goNext() {
                // console.log(currentOrder + " NEXT");
                if (currentOrder == null) return;
                const next = currentOrder === total ? 1 : currentOrder + 1;
                currentOrder = next;
                updatePopupContent(next);
            }
            function goPrev() {
                // console.log(currentOrder + " PREV");
                if (currentOrder == null) return;
                const prev = currentOrder === 1 ? total : currentOrder - 1;
                currentOrder = prev;
                updatePopupContent(prev);
            }

            // Event handlers (defined here to be removable)
            function handleOverlayClick(e) {
                if (e.target === popupOverlay) {
                    closePopup();
                }
            }

            let isHorizontalSwipe = false;
            let touchStartHandler, touchMoveHandler, handlePopupTouchEnd;

            function attachPopUpTouchNavigation(popupScrollable) {
                let startY = 0;
                let startX = 0;

                touchStartHandler = function (e) {
                    startY = e.touches[0].clientY;
                    startX = e.touches[0].clientX;
                    isHorizontalSwipe = false;
                };
                
                touchMoveHandler = function (e) {
                    const dy = e.touches[0].clientY - startY;
                    const dx = e.touches[0].clientX - startX;
                    
                    
                    const scrollTop = popupScrollable.scrollTop;
                    const scrollHeight = popupScrollable.scrollHeight;
                    const offsetHeight = popupScrollable.offsetHeight;
                    const isScrollable = scrollHeight > offsetHeight;
                    
                    const isScrollingVertically = Math.abs(dy) > Math.abs(dx);
                    if (!isScrollingVertically  && Math.abs(dx) >= 50) {
                        isHorizontalSwipe = true;
                        // if (e.cancelable && !e.defaultPrevented) {
                        //     // e.preventDefault();  // only block if we *can*
                        // }
                        // return;
                    };

                    if (isScrollingVertically && isScrollable) {

                        const atTop = scrollTop <= 0;
                        const atBottom = scrollTop + offsetHeight >= scrollHeight - 1;
                                            
                        const isPullingDown = dy > 0;
                        const isPullingUp = dy < 0;

                        if ((isPullingDown) || (isPullingUp)) {
                            e.stopPropagation(); // let scroll go
                            // if (e.cancelable && !e.defaultPrevented) {
                            //     // e.preventDefault();  // prevent rubber-banding
                            // }
                        } else {
                        }
                    }
                };

                handlePopupTouchEnd = function (e) {
                    if (!isHorizontalSwipe) return;

                    const touch = e.changedTouches[0];
                    const diffX = touch.clientX - startX;

                    if (diffX < 0) {
                        goNext();
                    } else {
                        goPrev();
                    }
                };

                popupScrollable.addEventListener('touchstart', touchStartHandler, { passive: true });
                popupScrollable.addEventListener('touchmove', touchMoveHandler, { passive: false });
                popupScrollable.addEventListener('touchend', handlePopupTouchEnd);
            }

            function removePopUpTouchNavigation(popupScrollable) {
                if (touchStartHandler) {
                    popupScrollable.removeEventListener('touchstart', touchStartHandler);
                }
                if (touchMoveHandler) {
                    popupScrollable.removeEventListener('touchmove', touchMoveHandler);
                }
                if (handlePopupTouchEnd) {
                    popupScrollable.removeEventListener('touchmove', handlePopupTouchEnd);
                }
            }

            const scrollable = popupOverlay.querySelector('.chakras-content');
            scrollable.setAttribute('tabindex', '0');
            scrollable.focus(); // focus so Arrow keys & PageDown work
            function handlePopupKeydown(e) {
                if (!popupOverlay || popupOverlay.style.display === 'none') return;
                if (e.key === 'ArrowRight') {
                    goNext();
                    e.preventDefault();
                }
                else if (e.key === 'ArrowLeft') {
                    goPrev();
                    e.preventDefault();
                }
                else if (e.key === 'Escape') {
                    closePopup();
                    e.preventDefault();
                }
            }

            function attachPopupListeners() {
                document.addEventListener('keydown', handlePopupKeydown);
                popupOverlay.addEventListener('click', handleOverlayClick);
                popupLeft.addEventListener('click', goPrev);
                popupRight.addEventListener('click', goNext);
                popupClose.addEventListener('click', closePopup);
                attachPopUpTouchNavigation(scrollable);
            }
            
            function removePopupListeners() {
                document.removeEventListener('keydown', handlePopupKeydown);
                popupOverlay.removeEventListener('click', handleOverlayClick);
                popupLeft.removeEventListener('click', goPrev);
                popupRight.removeEventListener('click', goNext);
                popupClose.removeEventListener('click', closePopup);
                removePopUpTouchNavigation(scrollable);
            }

            // Show popup
            function showPopup(order) {
                currentOrder = order;
                updatePopupContent(order);
                popupOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                attachPopupListeners();
                App.slider.disableInputs();
            }

            // Hide popup
            function closePopup() {
                popupOverlay.classList.remove('active');
                document.body.style.overflow = '';
                currentOrder = null;
                removePopupListeners();
                App.slider.enableInputs();
            }

            // Create chakra buttons and attach click to open popup
            storyData.chakras.forEach((chakra) => {
                const chakraDiv = document.createElement('div');
                chakraDiv.className = 'chakra hoverable clickable';
                chakraDiv.setAttribute('data-order', chakra.order);

                const innerDiv = document.createElement('div');
                innerDiv.className = 'chakra-inner hoverable clickable';

                const iconEl = document.createElement('i');
                iconEl.className = `fa-solid ${chakra.icon || ''}`;

                innerDiv.appendChild(iconEl);
                chakraDiv.appendChild(innerDiv);
                listWrapper.appendChild(chakraDiv);

                chakraDiv.addEventListener('click', () => {
                    showPopup(chakra.order);
                });
            });

        }

        // Storm
        function storyStorm() {
            const canvas = document.getElementById('storyStormCanvas');
            const ctx = canvas.getContext('2d');
            let animationId = null;

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const colorSet = {
                "fire": {
                    stroke: "164,114,114",
                    lightning: "255,255,0",
                    glow: "255,155,155"
                },
                "ice": {
                    stroke: "114,114,164",
                    lightning: "0,255,255",
                    glow: "155,255,255"
                }
            }
            
            function updateTheme() {
                return document.documentElement.getAttribute('data-theme');
            }

            function updateColor(theme) {
                return colorSet[theme];
            }

            class Raindrop {
                constructor() {
                    this.reset();
                }

                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = -10;
                    this.speed = Math.random() * 5 + 5;
                    this.length = Math.random() * 20 + 8;
                    this.thickness = Math.random() * 1.5 + 1;
                }

                update() {
                    this.y += this.speed;
                    if (this.y > canvas.height) {
                        this.reset();
                    }
                }

                draw() {
                    let currentTheme = updateTheme();
                    let color= updateColor(currentTheme);
                    ctx.beginPath();
                    ctx.strokeStyle = `rgba(${color.stroke}, 0.4)`;
                    ctx.lineWidth = this.thickness;
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + 1, this.y + this.length);
                    ctx.stroke();
                }
            }

            class Lightning {
                constructor(x) {
                    this.startX = x;
                    this.segments = [];
                    this.createTime = Date.now();
                    this.generatePath();
                }

                generatePath() {
                    let x = this.startX;
                    let y = 0;
                    
                    while (y < canvas.height) {
                        const newX = x + (Math.random() - 0.5) * 100;
                        const newY = y + Math.random() * 50;
                        this.segments.push({
                            x1: x,
                            y1: y,
                            x2: newX,
                            y2: newY
                        });
                        x = newX;
                        y = newY;
                    }
                }

                draw() {
                    const theme = updateTheme();
                    const color = updateColor(theme);
                    const age = Date.now() - this.createTime;
                    if (age < 100) {
                        const opacity = 1 - (age / 100);
                        
                        // Main strike
                        ctx.strokeStyle = `rgba(${color.lightning}, ${opacity})`;
                        ctx.lineWidth = 2;
                        this.segments.forEach(segment => {
                            ctx.beginPath();
                            ctx.moveTo(segment.x1, segment.y1);
                            ctx.lineTo(segment.x2, segment.y2);
                            ctx.stroke();
                        });

                        // Glow effect
                        ctx.strokeStyle = `rgba(${color.glow}, ${opacity * 0.5})`;
                        ctx.lineWidth = 6;
                        this.segments.forEach(segment => {
                            ctx.beginPath();
                            ctx.moveTo(segment.x1, segment.y1);
                            ctx.lineTo(segment.x2, segment.y2);
                            ctx.stroke();
                        });
                    }
                }
            }

            // Create raindrops
            const raindrops = [];
            const raindropCount = 300;
            for (let i = 0; i < raindropCount; i++) {
                raindrops.push(new Raindrop());
            }

            // Store lightning strikes
            const lightnings = [];

            // Animation function
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Update and draw raindrops
                raindrops.forEach(drop => {
                    drop.update();
                    drop.draw();
                });

                // Draw active lightning strikes
                lightnings.forEach((lightning, index) => {
                    lightning.draw();
                    if (Date.now() - lightning.createTime > 100) {
                        lightnings.splice(index, 1);
                    }
                });

                // Random lightning
                if (Math.random() < 0.001) {
                    createLightning();
                }

                animationId = requestAnimationFrame(animate);
            }

            function createLightning() {
                const x = Math.random() * canvas.width;
                lightnings.push(new Lightning(x));
            }

            function clearCanvas(canvas) {
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }


            document.querySelector('#themeToggle').addEventListener('click', () => {
                cancelAnimationFrame(animationId); // STOP previous loop
                clearCanvas(canvas);
                animate(); // START clean
            });


            // Click handler
            canvas.addEventListener('click', (e) => {
                lightnings.push(new Lightning(e.clientX));
            });

            // Touch handler for mobile
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                lightnings.push(new Lightning(e.touches[0].clientX));
            });

            // Window resize handler
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });

            // Start animation
            animate();

                    
            setTimeout(() => {
                canvas.style.setProperty("opacity", 1);
            }, 3000);

        }

        generateStoryContent(storyData);
        
        setTimeout(() => {
            storyStorm();
        }, 1000);

        setTimeout(() => {
            App.slider.enableInputs();
        }, 2000);
    }

    App.sections.storyChakrasUsual = function() {
    }


})(window.App);